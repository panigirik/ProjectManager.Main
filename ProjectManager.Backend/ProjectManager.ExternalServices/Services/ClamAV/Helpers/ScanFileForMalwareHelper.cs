using System.ComponentModel.DataAnnotations;
using System.Net.Sockets;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Configuration;
using nClam;

namespace ProjectManager.ExternalServices.Services.ClamAV.Helpers;

public class ScanFileForMalwareHelper
{
    private readonly string _clamAvHost;
    private readonly int _clamAvPort;
    private readonly bool _clamAVEnabled;

    public ScanFileForMalwareHelper(IConfiguration configuration)
    {
        _clamAvHost = configuration["ClamAvConnection:Host"] ??
                      throw new InvalidOperationException("ClamAV Host not found in configuration.");
        _clamAvPort = int.Parse(configuration["ClamAvConnection:Port"] ??
                                throw new InvalidOperationException("ClamAV Port is missing or invalid."));
        _clamAVEnabled = bool.Parse(configuration["ClamAvConnection:IsEnabled"]);
    }

    /// <summary>
    /// Task для осуществления проверки на вредоносное ПО
    /// </summary>
    public async Task ScanFileAsync(IFormFile file)
    {
        try
        {
            var clamClient = new ClamClient(_clamAvHost, _clamAvPort);
            using var stream = file.OpenReadStream();
            var scanResult = await clamClient.SendAndScanFileAsync(stream);
            if (scanResult.Result == ClamScanResults.VirusDetected)
            {
                throw new ValidationException($"Malware detected {scanResult.InfectedFiles}");
            }
        }
        catch (SocketException)
        {
            throw new InvalidOperationException("ClamAV not responding");
        }
    }

    /// <summary>
    /// Тест соединения антивируса
    /// </summary>
    public async Task TestConnectionAsync()
    {
        try
        {
            var clamClient = new ClamClient(_clamAvHost, _clamAvPort);
            if (!await clamClient.PingAsync())
            {
                Console.WriteLine("ClamAV not responding");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error connecting to ClamAV: {ex.Message}");
        }
    }
}